{"version":3,"sources":["../../src/tileset-manager/tileset-manager.ts"],"names":["EventEmitter","DEFAULT_CACHE_SCALE","DEFAULT_EXTENT","NOOP","UPDATE_TILE_STRATEGIES","Tile","UpdateTileStrategy","getTileIndices","TilesetManager","options","Map","tile","emit","updateTileVisible","error","tileSize","minZoom","maxZoom","Infinity","zoomOffset","extent","getTileData","updateStrategy","Overlap","updateOptions","currentTiles","every","isDone","tiles","Array","from","cacheTiles","values","sort","t1","t2","z","undefined","Math","ceil","floor","zoom","latLonBounds","lastViewStates","toString","isAddTile","tileIndices","map","x","y","getTile","createTile","resizeCacheTiles","rebuildTileTree","tileId","includes","delete","onTileUnload","loadData","getData","onLoad","onTileLoad","onError","onTileError","isLoading","abortLoad","clear","removeAllListeners","beforeVisible","set","key","isVisible","isCurrent","isVisibleChange","some","get","indices","getTileId","maxCacheSize","length","overflown","size","parent","children","getNearestAncestor","push"],"mappings":"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","sourcesContent":["import EventEmitter from 'eventemitter3';\nimport {\n  DEFAULT_CACHE_SCALE,\n  DEFAULT_EXTENT,\n  NOOP,\n  UPDATE_TILE_STRATEGIES,\n} from './const';\nimport { Tile } from './tile';\nimport { TilesetManagerOptions, UpdateTileStrategy } from './types';\nimport { getTileIndices } from './utils/lonlat-tile';\n\n/**\n * 管理瓦片数据\n */\nexport class TilesetManager extends EventEmitter {\n  public get isLoaded() {\n    return this.currentTiles.every((tile) => tile.isDone);\n  }\n  // 缓存的瓦片数组\n  public get tiles() {\n    // 通过 zoom 层级排序，最小的层级在上面\n    const tiles = Array.from(this.cacheTiles.values()).sort(\n      (t1, t2) => t1.z - t2.z,\n    );\n    return tiles;\n  }\n  // 当前层级的瓦片\n  public currentTiles: Tile[] = [];\n  // 配置项\n  protected options: TilesetManagerOptions;\n  // 缓存的瓦片，key 为 {z}-{x}-{y}\n  private cacheTiles = new Map<string, Tile>();\n  // 上一次视野状态\n  private lastViewStates: {\n    zoom: number;\n    latLonBounds: [number, number, number, number];\n  };\n\n  constructor(options: Partial<TilesetManagerOptions>) {\n    super();\n    this.options = {\n      tileSize: 256,\n      minZoom: 0,\n      maxZoom: Infinity,\n      zoomOffset: 0,\n      extent: DEFAULT_EXTENT,\n      getTileData: NOOP,\n      updateStrategy: UpdateTileStrategy.Overlap,\n    };\n    this.updateOptions(options);\n  }\n\n  // 更新配置项\n  public updateOptions(options: Partial<TilesetManagerOptions>) {\n    const minZoom =\n      options.minZoom === undefined\n        ? this.options.minZoom\n        : Math.ceil(options.minZoom);\n    const maxZoom =\n      options.maxZoom === undefined\n        ? this.options.maxZoom\n        : Math.floor(options.maxZoom);\n    this.options = { ...this.options, ...options, minZoom, maxZoom };\n  }\n\n  // 更新\n  // 1.瓦片序号发生改变 2.瓦片新增 3.瓦片显隐控制\n  public update(zoom: number, latLonBounds: [number, number, number, number]) {\n    if (\n      this.lastViewStates &&\n      this.lastViewStates.zoom === zoom &&\n      this.lastViewStates.latLonBounds.toString() === latLonBounds.toString()\n    ) {\n      return;\n    }\n\n    this.lastViewStates = { zoom, latLonBounds };\n\n    let isAddTile = false;\n    const tileIndices = this.getTileIndices(zoom, latLonBounds);\n\n    this.currentTiles = tileIndices.map(({ x, y, z }) => {\n      let tile = this.getTile(x, y, z);\n      if (tile) {\n        return tile;\n      }\n\n      tile = this.createTile(x, y, z);\n      isAddTile = true;\n      return tile;\n    });\n\n    if (isAddTile) {\n      // 更新缓存\n      this.resizeCacheTiles();\n      // 重新瓦片树\n      this.rebuildTileTree();\n    }\n\n    // 更新瓦片显示状态\n    this.updateTileVisible();\n  }\n\n  // 重新加载瓦片\n  public reloadAll() {\n    for (const [tileId, tile] of this.cacheTiles) {\n      if (!this.currentTiles.includes(tile)) {\n        this.cacheTiles.delete(tileId);\n        this.onTileUnload(tile);\n      }\n      this.onTileUnload(tile);\n      tile.loadData({\n        getData: this.options.getTileData,\n        onLoad: this.onTileLoad,\n        onError: this.onTileError,\n      });\n    }\n  }\n\n  // 摧毁\n  public destroy() {\n    for (const tile of this.cacheTiles.values()) {\n      if (tile.isLoading) {\n        tile.abortLoad();\n      }\n    }\n    this.cacheTiles.clear();\n    this.currentTiles = [];\n    this.removeAllListeners();\n  }\n\n  // 更新瓦片显隐状态\n  public updateTileVisible() {\n    const updateStrategy = this.options.updateStrategy;\n    const beforeVisible = new Map<string, boolean>();\n\n    // 重置显示状态\n    for (const tile of this.cacheTiles.values()) {\n      // 存储已经显示的瓦片\n      beforeVisible.set(tile.key, tile.isVisible);\n      tile.isCurrent = false;\n      tile.isVisible = false;\n    }\n    // 设置当前视野的瓦片为可见\n    for (const tile of this.currentTiles) {\n      tile.isCurrent = true;\n      tile.isVisible = true;\n    }\n\n    const tiles = Array.from(this.cacheTiles.values());\n\n    if (typeof updateStrategy === 'function') {\n      updateStrategy(tiles);\n    } else {\n      UPDATE_TILE_STRATEGIES[updateStrategy](tiles);\n    }\n\n    // 检查瓦片显示状态是否发生改变\n    const isVisibleChange = Array.from(this.cacheTiles.values()).some(\n      (tile) => tile.isVisible !== beforeVisible.get(tile.key),\n    );\n\n    if (isVisibleChange) {\n      this.emit('tile-update');\n    }\n  }\n\n  // 获取当前视野层级瓦片的所有索引\n  protected getTileIndices(\n    zoom: number,\n    latLonBounds: [number, number, number, number],\n  ) {\n    const { tileSize, extent, zoomOffset } = this.options;\n    const maxZoom = Math.floor(this.options.maxZoom);\n    const minZoom = Math.ceil(this.options.minZoom);\n\n    const indices = getTileIndices({\n      maxZoom,\n      minZoom,\n      zoomOffset,\n      tileSize,\n      zoom,\n      latLonBounds,\n      extent,\n    });\n\n    return indices;\n  }\n\n  // 瓦片加载成功回调\n  private onTileLoad = (tile: Tile) => {\n    this.emit('tile-loaded', tile);\n    this.updateTileVisible();\n  };\n\n  // 瓦片加载失败回调\n  private onTileError = (error: Error, tile: Tile) => {\n    this.emit('tile-error', { error, tile });\n    this.updateTileVisible();\n  };\n\n  // 瓦片被删除回调\n  private onTileUnload = (tile: Tile) => {\n    this.emit('tile-unload', tile);\n  };\n\n  // 获取瓦片 ID\n  private getTileId(x: number, y: number, z: number) {\n    const tileId = `${x},${y},${z}`;\n    return tileId;\n  }\n\n  // 获取瓦片\n  private getTile(x: number, y: number, z: number) {\n    const tileId = this.getTileId(x, y, z);\n    const tile = this.cacheTiles.get(tileId);\n\n    return tile;\n  }\n\n  // 创建瓦片\n  private createTile(x: number, y: number, z: number) {\n    const tileId = this.getTileId(x, y, z);\n    const tile = new Tile({ x, y, z, tileSize: this.options.tileSize });\n\n    this.cacheTiles.set(tileId, tile);\n    tile.loadData({\n      getData: this.options.getTileData,\n      onLoad: this.onTileLoad,\n      onError: this.onTileError,\n    });\n\n    return tile;\n  }\n\n  // 当缓存超过最大值时，清除不可见的瓦片\n  private resizeCacheTiles() {\n    const maxCacheSize = DEFAULT_CACHE_SCALE * this.currentTiles.length;\n\n    const overflown = this.cacheTiles.size > maxCacheSize;\n\n    if (overflown) {\n      for (const [tileId, tile] of this.cacheTiles) {\n        if (!tile.isVisible && !this.currentTiles.includes(tile)) {\n          this.cacheTiles.delete(tileId);\n          this.onTileUnload(tile);\n        }\n        if (this.cacheTiles.size <= maxCacheSize) {\n          break;\n        }\n      }\n    }\n  }\n\n  // 重新计算瓦片树\n  private rebuildTileTree() {\n    // 清空瓦片上的数据\n    for (const tile of this.cacheTiles.values()) {\n      tile.parent = null;\n      tile.children.length = 0;\n    }\n\n    // 重新计算瓦片上的关系树\n    for (const tile of this.cacheTiles.values()) {\n      const parent = this.getNearestAncestor(tile.x, tile.y, tile.z);\n      tile.parent = parent;\n      if (parent?.children) {\n        parent.children.push(tile);\n      }\n    }\n  }\n\n  // 获取瓦片的最近上级的瓦片\n  private getNearestAncestor(x: number, y: number, z: number) {\n    while (z > this.options.minZoom) {\n      x = Math.floor(x / 2);\n      y = Math.floor(y / 2);\n      z = z - 1;\n      const parent = this.getTile(x, y, z);\n      if (parent) {\n        return parent;\n      }\n    }\n    return null;\n  }\n}\n"],"file":"tileset-manager.js"}