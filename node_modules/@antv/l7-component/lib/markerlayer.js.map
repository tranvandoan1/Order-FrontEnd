{"version":3,"sources":["../src/markerlayer.ts"],"names":["MarkerLayer","option","markerLayerOption","getDefault","zoom","clusterOption","cluster","radius","maxZoom","minZoom","style","className","scene","mapsService","get","TYPES","IMapService","initCluster","update","on","addMarkers","marker","addPoint","markers","length","getZoom","bbox","getBounds","Math","floor","getClusterMarker","push","indexOf","markerIndex","splice","map","m","getElement","opacity","clusterMarkers","getMarkers","forEach","addTo","remove","clusterMarker","off","clear","removeAllListeners","id","getLnglat","lng","lat","feature","geometry","type","coordinates","properties","getExtData","marker_id","points","clusterIndex","load","Supercluster","viewBounds","viewBBox","concat","clusterPoint","getClusters","field","method","cluster_id","clusterData","getLeaves","columnData","item","data","column","Satistics","getColumn","stat","getSatByColumn","fieldName","toFixed","clusterId","limit","Infinity","offset","element","generateElement","bind","Marker","setLnglat","abs","el","DOM","create","label","span","point_count","text","textContent","EventEmitter"],"mappings":"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","sourcesContent":["import { IMapService, IMarker, TYPES } from '@antv/l7-core';\nimport {\n  bindAll,\n  boundsContains,\n  DOM,\n  IBounds,\n  padBounds,\n  Satistics,\n} from '@antv/l7-utils';\nimport { EventEmitter } from 'eventemitter3';\nimport { Container } from 'inversify';\nimport { merge } from 'lodash';\n// @ts-ignore\n// tslint:disable-next-line:no-submodule-imports\nimport Supercluster from 'supercluster/dist/supercluster';\nimport Marker from './marker';\ntype CallBack = (...args: any[]) => any;\ninterface IMarkerStyleOption {\n  element?: CallBack;\n  style: { [key: string]: any } | CallBack;\n  className: string;\n  field?: string;\n  method?: 'sum' | 'max' | 'min' | 'mean';\n  radius: number;\n  maxZoom: number;\n  minZoom: number;\n  zoom: number;\n}\n\ninterface IMarkerLayerOption {\n  cluster: boolean;\n  clusterOption: Partial<IMarkerStyleOption>;\n}\n\ninterface IPointFeature {\n  geometry: {\n    type: 'Point';\n    coordinates: [number, number];\n  };\n  properties: any;\n}\nexport default class MarkerLayer extends EventEmitter {\n  private markers: IMarker[] = [];\n  private markerLayerOption: IMarkerLayerOption;\n  private clusterIndex: Supercluster;\n  private points: IPointFeature[] = [];\n  private clusterMarkers: IMarker[] = [];\n  private mapsService: IMapService<unknown>;\n  private scene: Container;\n  private zoom: number;\n  private bbox: IBounds;\n\n  constructor(option?: Partial<IMarkerLayerOption>) {\n    super();\n    this.markerLayerOption = merge(this.getDefault(), option);\n    bindAll(['update'], this);\n    this.zoom = this.markerLayerOption.clusterOption?.zoom || -99;\n  }\n  public getDefault() {\n    return {\n      cluster: false,\n      clusterOption: {\n        radius: 80,\n        maxZoom: 20,\n        minZoom: 0,\n        zoom: -99,\n        style: {},\n        className: '',\n      },\n    };\n  }\n  public addTo(scene: Container) {\n    // this.remove();\n    this.scene = scene;\n    this.mapsService = scene.get<IMapService>(TYPES.IMapService);\n    if (this.markerLayerOption.cluster) {\n      this.initCluster();\n      this.update();\n      // 地图视野变化时，重新计算视野内的聚合点。\n      this.mapsService.on('camerachange', this.update); // amap1.x 更新事件\n      this.mapsService.on('viewchange', this.update); // amap2.0 更新事件\n    }\n    this.addMarkers();\n    return this;\n  }\n  public addMarker(marker: IMarker) {\n    const cluster = this.markerLayerOption.cluster;\n    if (cluster) {\n      this.addPoint(marker, this.markers.length);\n      if (this.mapsService) {\n        // 在新增 marker 的时候需要更新聚合信息（哪怕此时的 zoom 没有发生变化）\n        const zoom = this.mapsService.getZoom();\n        const bbox = this.mapsService.getBounds();\n        this.bbox = padBounds(bbox, 0.5);\n        this.zoom = Math.floor(zoom);\n        this.getClusterMarker(this.bbox, this.zoom);\n      }\n    }\n    this.markers.push(marker);\n  }\n\n  public removeMarker(marker: IMarker) {\n    this.markers.indexOf(marker);\n    const markerIndex = this.markers.indexOf(marker);\n    if (markerIndex > -1) {\n      this.markers.splice(markerIndex, 1);\n    }\n  }\n\n  /**\n   * 隐藏 marker 在每个 marker 上单独修改属性而不是在 markerContainer 上修改（在 markerContainer 修改会有用户在场景加载完之前调用失败的问题）\n   */\n  public hide() {\n    this.markers.map((m) => {\n      m.getElement().style.opacity = '0';\n    });\n\n    this.clusterMarkers.map((m) => {\n      m.getElement().style.opacity = '0';\n    });\n  }\n\n  /**\n   * 显示 marker\n   */\n  public show() {\n    this.markers.map((m) => {\n      m.getElement().style.opacity = '1';\n    });\n\n    this.clusterMarkers.map((m) => {\n      m.getElement().style.opacity = '1';\n    });\n  }\n\n  public getMarkers() {\n    const cluster = this.markerLayerOption.cluster;\n    return cluster ? this.clusterMarkers : this.markers;\n  }\n\n  public addMarkers() {\n    this.getMarkers().forEach((marker: IMarker) => {\n      marker.addTo(this.scene);\n    });\n  }\n  public clear() {\n    this.markers.forEach((marker: IMarker) => {\n      marker.remove();\n    });\n    this.clusterMarkers.forEach((clusterMarker: IMarker) => {\n      clusterMarker.remove();\n    });\n    this.mapsService.off('camerachange', this.update);\n    this.markers = [];\n    this.clusterMarkers = [];\n  }\n\n  public destroy() {\n    this.clear();\n    this.removeAllListeners();\n  }\n\n  private addPoint(marker: IMarker, id: number) {\n    const { lng, lat } = marker.getLnglat();\n    const feature: IPointFeature = {\n      geometry: {\n        type: 'Point',\n        coordinates: [lng, lat],\n      },\n      properties: {\n        ...marker.getExtData(),\n        marker_id: id,\n      },\n    };\n    this.points.push(feature);\n    if (this.clusterIndex) {\n      // 在新增点的时候需要更新 cluster 的数据\n      this.clusterIndex.load(this.points);\n    }\n  }\n\n  private initCluster() {\n    if (!this.markerLayerOption.cluster) {\n      return;\n    }\n    const { radius, minZoom = 0, maxZoom } = this.markerLayerOption\n      .clusterOption as IMarkerStyleOption;\n    this.clusterIndex = new Supercluster({\n      radius,\n      minZoom,\n      maxZoom,\n    });\n    // @ts-ignore\n    this.clusterIndex.load(this.points);\n  }\n\n  private getClusterMarker(viewBounds: IBounds, zoom: number) {\n    const viewBBox = viewBounds[0].concat(viewBounds[1]);\n    const clusterPoint = this.clusterIndex.getClusters(viewBBox, zoom);\n    this.clusterMarkers.forEach((marker: IMarker) => {\n      marker.remove();\n    });\n    this.clusterMarkers = [];\n    clusterPoint.forEach((feature: any) => {\n      const { field, method } = this.markerLayerOption.clusterOption;\n      // 处理聚合数据\n      if (feature.properties && feature.properties?.cluster_id) {\n        const clusterData = this.getLeaves(feature.properties?.cluster_id);\n        feature.properties.clusterData = clusterData;\n        if (field && method) {\n          const columnData = clusterData?.map((item: any) => {\n            const data = {\n              [field]: item.properties[field],\n            };\n            return data;\n          });\n          const column = Satistics.getColumn(columnData as any, field);\n          const stat = Satistics.getSatByColumn(method, column);\n          const fieldName = 'point_' + method;\n          feature.properties[fieldName] = stat.toFixed(2);\n        }\n      }\n      const marker = this.clusterMarker(feature);\n      this.clusterMarkers.push(marker);\n      marker.addTo(this.scene);\n    });\n  }\n  private getLeaves(\n    clusterId: number,\n    limit: number = Infinity,\n    offset: number = 0,\n  ) {\n    if (!clusterId) {\n      return null;\n    }\n    return this.clusterIndex.getLeaves(clusterId, limit, offset);\n  }\n  private clusterMarker(feature: any) {\n    const clusterOption = this.markerLayerOption.clusterOption;\n\n    const {\n      element = this.generateElement.bind(this),\n    } = clusterOption as IMarkerStyleOption;\n    const marker = new Marker({\n      element: element(feature),\n    }).setLnglat({\n      lng: feature.geometry.coordinates[0],\n      lat: feature.geometry.coordinates[1],\n    });\n    return marker;\n  }\n  private normalMarker(feature: any) {\n    const marker_id = feature.properties.marker_id;\n    return this.markers[marker_id];\n  }\n\n  private update() {\n    if (!this.mapsService) {\n      return;\n    }\n    const zoom = this.mapsService.getZoom();\n    const bbox = this.mapsService.getBounds();\n    if (\n      !this.bbox ||\n      Math.abs(zoom - this.zoom) >= 1 ||\n      !boundsContains(this.bbox, bbox)\n    ) {\n      this.bbox = padBounds(bbox, 0.5);\n      this.zoom = Math.floor(zoom);\n      this.getClusterMarker(this.bbox, this.zoom);\n    }\n  }\n\n  private generateElement(feature: any) {\n    const el = DOM.create('div', 'l7-marker-cluster');\n    const label = DOM.create('div', '', el);\n    const span = DOM.create('span', '', label);\n    const { field, method } = this.markerLayerOption.clusterOption;\n    feature.properties.point_count = feature.properties.point_count || 1;\n\n    const text =\n      field && method\n        ? feature.properties['point_' + method] || feature.properties[field]\n        : feature.properties.point_count;\n    span.textContent = text;\n    return el;\n  }\n}\n"],"file":"markerlayer.js"}